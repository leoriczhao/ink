name: ci

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format:
    name: Format (clang-format)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        timeout-minutes: 5
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          for i in 1 2 3; do sudo apt-get update -y && break || sleep 10; done
          for i in 1 2 3; do sudo apt-get install -y --no-install-recommends clang-format && break || sleep 10; done

      - name: Check formatting (changed files only)
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before }}"
          if [ -z "$BASE_SHA" ]; then
            BASE_SHA=$(git rev-list --max-parents=0 HEAD)
          fi

          FILES=$(git diff --name-only "$BASE_SHA"...HEAD | \
            grep -E '^(include|src|tests|examples)/.*\.(h|hpp|c|cc|cpp)$' || true)

          if [ -n "$FILES" ]; then
            echo "$FILES" | xargs clang-format --dry-run --Werror
          else
            echo "No C/C++ source changes to format-check."
          fi

  build-test:
    name: Build & Test (${{ matrix.compiler }}, ${{ matrix.build_type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        build_type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 5
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          for i in 1 2 3; do sudo apt-get update -y && break || sleep 10; done
          for i in 1 2 3; do sudo apt-get install -y --no-install-recommends cmake ninja-build gcc g++ clang libsdl2-dev && break || sleep 10; done

      - name: Configure
        env:
          CC: ${{ matrix.compiler == 'gcc' && 'gcc' || 'clang' }}
          CXX: ${{ matrix.compiler == 'gcc' && 'g++' || 'clang++' }}
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DINK_BUILD_TESTS=ON \
            -DINK_ENABLE_GL=OFF \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure

  clang-tidy:
    name: clang-tidy (gate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 5
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          for i in 1 2 3; do sudo apt-get update -y && break || sleep 10; done
          for i in 1 2 3; do sudo apt-get install -y --no-install-recommends cmake ninja-build clang clang-tidy libsdl2-dev && break || sleep 10; done

      - name: Configure
        env:
          CC: clang
          CXX: clang++
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DINK_BUILD_TESTS=ON \
            -DINK_ENABLE_GL=OFF \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy (core src only)
        run: |
          find src -type f \( -name '*.cpp' -o -name '*.cc' -o -name '*.cxx' \) ! -path 'src/gpu/*' | \
            xargs -r clang-tidy -p build --warnings-as-errors='*' \
              --checks='-*,bugprone-*,performance-*,misc-unused-*,-bugprone-easily-swappable-parameters,-bugprone-narrowing-conversions,-bugprone-implicit-widening-of-multiplication-result'

  sanitizers:
    name: Sanitizers (ASan + UBSan)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 5
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          for i in 1 2 3; do sudo apt-get update -y && break || sleep 10; done
          for i in 1 2 3; do sudo apt-get install -y --no-install-recommends cmake ninja-build clang libsdl2-dev && break || sleep 10; done

      - name: Configure
        env:
          CC: clang
          CXX: clang++
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DINK_BUILD_TESTS=ON \
            -DINK_ENABLE_GL=OFF \
            -DCMAKE_C_FLAGS='-fsanitize=address,undefined -fno-omit-frame-pointer' \
            -DCMAKE_CXX_FLAGS='-fsanitize=address,undefined -fno-omit-frame-pointer' \
            -DCMAKE_EXE_LINKER_FLAGS='-fsanitize=address,undefined' \
            -DCMAKE_SHARED_LINKER_FLAGS='-fsanitize=address,undefined'

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        env:
          ASAN_OPTIONS: detect_leaks=1:strict_string_checks=1
          UBSAN_OPTIONS: print_stacktrace=1
        run: ctest --test-dir build --output-on-failure
